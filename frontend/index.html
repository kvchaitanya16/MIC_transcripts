<!doctype html>
<html data-theme="light">
  <head>
    <meta charset="utf-8" />
    <title>Live Transcription</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #ffffff;
        --fg: #0f172a;          /* slate-900 */
        --muted: #64748b;       /* slate-500 */
        --card: #f8fafc;        /* slate-50 */
        --border: #e2e8f0;      /* slate-200 */
        --btn-bg: #111827;      /* gray-900 */
        --btn-fg: #ffffff;
        --btn-bg-hover: #000000;
        --input-bg: #ffffff;
        --accent: #2563eb;      /* blue-600 */
      }
      [data-theme="dark"] {
        --bg: #0b1020;
        --fg: #e5e7eb;          /* slate-200 */
        --muted: #9ca3af;       /* gray-400 */
        --card: #111827;        /* gray-900 */
        --border: #1f2937;      /* gray-800 */
        --btn-bg: #2563eb;      /* blue-600 */
        --btn-fg: #ffffff;
        --btn-bg-hover: #1d4ed8;
        --input-bg: #0f172a;    /* slate-900 */
        --accent: #60a5fa;      /* blue-400 */
      }

      * { box-sizing: border-box; }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
        margin: 2rem;
        background: var(--bg);
        color: var(--fg);
        transition: background 0.2s ease, color 0.2s ease;
      }
      h1 { margin-bottom: 0.75rem; }
      .row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
      }
      button {
        padding: 0.7rem 1rem;
        font-size: 1rem;
        cursor: pointer;
        border-radius: 0.6rem;
        border: 1px solid var(--border);
        background: var(--btn-bg);
        color: var(--btn-fg);
        transition: background 0.15s ease, transform 0.02s ease, opacity 0.2s ease;
      }
      button:hover { background: var(--btn-bg-hover); }
      button:active { transform: translateY(1px); }
      button[disabled] { opacity: 0.6; cursor: not-allowed; }
      .secondary {
        background: transparent;
        color: var(--fg);
      }
      .secondary:hover {
        background: var(--card);
      }
      #text {
        width: 100%;
        height: 240px;
        margin-top: 1rem;
        font-size: 1rem;
        padding: 0.75rem;
        border-radius: 0.6rem;
        border: 1px solid var(--border);
        background: var(--input-bg);
        color: var(--fg);
      }
      .status {
        margin-left: 0.25rem;
        font-size: 0.95rem;
        color: var(--muted);
      }
      hr {
        border: none;
        border-top: 1px solid var(--border);
        margin: 1.25rem 0;
      }

      /* Answers section */
      .answers-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 1rem;
        margin: 1rem 0 0.5rem;
      }
      .answers-grid {
        display: grid;
        grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) );
        gap: 0.9rem;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        padding: 0.9rem;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        min-height: 140px;
      }
      .card h3 {
        margin: 0;
        font-size: 1rem;
        color: var(--accent);
      }
      .card pre {
        margin: 0;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 0.95rem;
        color: var(--fg);
      }
      .card .actions {
        display: flex;
        gap: 0.5rem;
        margin-top: auto;
      }
      .pill {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <h1>Live Transcription</h1>

    <div class="row">
      <button id="micBtn">üéôÔ∏è Start</button>
      <button id="submitBtn" class="secondary" disabled>‚úÖ Submit Answer</button>
      <button id="endBtn" class="secondary" disabled>üõë End Session</button>
      <span class="status" id="status">Idle</span>
      <span style="flex:1"></span>
      <button id="themeToggle" title="Toggle dark mode">üåô Dark</button>
    </div>

    <hr />

    <textarea id="text" placeholder="Live transcript appears here..." readonly></textarea>

    <div class="answers-header">
      <h2>Your Answers</h2>
      <span class="pill"><span id="answerCount">0</span> saved</span>
    </div>
    <div id="answers" class="answers-grid"></div>

    <script>
      // ---- Theme setup ----
      const THEME_KEY = "transcripto-theme";
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      const savedTheme = localStorage.getItem(THEME_KEY);
      const initialTheme = savedTheme || (prefersDark ? "dark" : "light");
      const root = document.documentElement;
      const themeToggle = document.getElementById("themeToggle");

      function applyTheme(mode) {
        root.setAttribute("data-theme", mode);
        themeToggle.textContent = mode === "dark" ? "‚òÄÔ∏è Light" : "üåô Dark";
        themeToggle.setAttribute("aria-pressed", mode === "dark" ? "true" : "false");
      }
      applyTheme(initialTheme);

      themeToggle.addEventListener("click", () => {
        const next = root.getAttribute("data-theme") === "dark" ? "light" : "dark";
        applyTheme(next);
        localStorage.setItem(THEME_KEY, next);
      });

      if (!savedTheme && window.matchMedia) {
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
          applyTheme(e.matches ? "dark" : "light");
        });
      }

      // ---- Elements ----
      const micBtn = document.getElementById("micBtn");
      const submitBtn = document.getElementById("submitBtn");
      const endBtn = document.getElementById("endBtn");
      const statusEl = document.getElementById("status");
      const textArea = document.getElementById("text");
      const answersWrap = document.getElementById("answers");
      const answerCountEl = document.getElementById("answerCount");

      // ---- State ----
      let mediaRecorder = null;
      let ws = null;
      let recording = false;
      let answers = [];

      // ---- Helpers ----
      function enableSessionControls(enabled) {
        submitBtn.disabled = !enabled;
        endBtn.disabled = !enabled;
      }

      function createAnswerCard(index, text) {
        const card = document.createElement("div");
        card.className = "card";

        const title = document.createElement("h3");
        title.textContent = `Answer ${index}`;

        const pre = document.createElement("pre");
        pre.textContent = text || "(empty)";

        const actions = document.createElement("div");
        actions.className = "actions";

        const copyBtn = document.createElement("button");
        copyBtn.className = "secondary";
        copyBtn.textContent = "üìã Copy";
        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(text);
            copyBtn.textContent = "‚úÖ Copied";
            setTimeout(() => (copyBtn.textContent = "üìã Copy"), 1200);
          } catch {
            // ignore
          }
        });

        actions.appendChild(copyBtn);
        card.appendChild(title);
        card.appendChild(pre);
        card.appendChild(actions);
        return card;
      }

      function addAnswer(text) {
        answers.push(text);
        const idx = answers.length;
        answersWrap.appendChild(createAnswerCard(idx, text));
        answerCountEl.textContent = String(answers.length);
      }

      function clearLiveArea() {
        textArea.value = "";
        textArea.scrollTop = 0;
      }

      // ---- WebSocket + Media ----
      async function start() {
        ws = new WebSocket("ws://localhost:8000/ws/transcribe");
        ws.binaryType = "arraybuffer";

        ws.onopen = () => {
          statusEl.textContent = "WebSocket connected, awaiting mic‚Ä¶";
        };

        ws.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data);

            switch (msg.type) {
              case "ready":
                statusEl.textContent = "Ready. Starting mic‚Ä¶";
                startMedia();
                break;

              case "partial":
              case "final":
                textArea.value = msg.text || "";
                textArea.scrollTop = textArea.scrollHeight;
                // If there is any text, enable submit
                submitBtn.disabled = !textArea.value.trim();
                break;

              case "submitted":
                addAnswer(msg.text || "");
                break;

              case "clear_current":
                clearLiveArea();
                submitBtn.disabled = true;
                break;

              case "session_end":
                // Add any server-sent final list (in case end captured tail)
                if (Array.isArray(msg.answers)) {
                  answers = msg.answers.slice();
                  answersWrap.innerHTML = "";
                  answers.forEach((t, i) => answersWrap.appendChild(createAnswerCard(i + 1, t)));
                  answerCountEl.textContent = String(answers.length);
                }
                statusEl.textContent = "Session ended";
                enableSessionControls(false);
                micBtn.disabled = true;
                if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
                if (ws && ws.readyState === WebSocket.OPEN) ws.close();
                break;

              case "ack":
                // optional: console.debug("chunk ack", msg.bytes);
                break;

              case "warning":
                console.warn(msg.message);
                break;

              case "error":
                console.error(msg.message);
                break;
            }
          } catch {
            // ignore non-JSON
          }
        };

        ws.onclose = () => {
          statusEl.textContent = "WebSocket closed";
          enableSessionControls(false);
          recording = false;
          micBtn.textContent = "üéôÔ∏è Start";
        };
      }

      async function startMedia() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const type = MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
            ? "audio/webm;codecs=opus"
            : "audio/webm";

          mediaRecorder = new MediaRecorder(stream, { mimeType: type });

          mediaRecorder.addEventListener("dataavailable", (e) => {
            if (e.data && e.data.size > 0 && ws && ws.readyState === WebSocket.OPEN) {
              e.data.arrayBuffer().then((buf) => ws.send(buf));
            }
          });

          mediaRecorder.addEventListener("start", () => {
            statusEl.textContent = "Recording‚Ä¶";
            micBtn.textContent = "‚èπ Stop";
            recording = true;
            enableSessionControls(true);
            submitBtn.disabled = true; // until we receive some text
          });

          mediaRecorder.addEventListener("stop", () => {
            statusEl.textContent = "Stopped";
            micBtn.textContent = "üéôÔ∏è Start";
            recording = false;
            if (ws && ws.readyState === WebSocket.OPEN) ws.close();
          });

          // Emit chunks regularly so backend can transcribe often
          mediaRecorder.start(800); // ~0.8s per chunk
        } catch (err) {
          statusEl.textContent = "Mic error";
          console.error(err);
        }
      }

      // ---- UI events ----
      micBtn.addEventListener("click", async () => {
        if (!recording) {
          // reset UI state for a new session
          clearLiveArea();
          answers = [];
          answersWrap.innerHTML = "";
          answerCountEl.textContent = "0";
          micBtn.disabled = true;
          await start();
          micBtn.disabled = false;
        } else {
          if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
        }
      });

      submitBtn.addEventListener("click", () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        ws.send(JSON.stringify({ type: "submit" }));
      });

      endBtn.addEventListener("click", () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        ws.send(JSON.stringify({ type: "end" }));
      });
    </script>
  </body>
</html>